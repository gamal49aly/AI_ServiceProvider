<p-toast></p-toast>

<div
  class="min-h-screen bg-slate-50 dark:bg-slate-950 py-12 px-4 transition-colors duration-300"
>
  <div class="container mx-auto max-w-5xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-12 animate-fade-in-down">
      <div class="flex items-center gap-4">
        <div
          class="inline-flex items-center justify-center w-12 h-12 bg-indigo-100 dark:bg-indigo-900/30 rounded-xl"
        >
          <i
            class="pi pi-volume-up text-2xl text-indigo-600 dark:text-indigo-400"
          ></i>
        </div>
        <div>
          <h1 class="text-3xl font-bold text-slate-900 dark:text-white">
            Text to Speech
          </h1>
          <p class="text-sm text-slate-500 dark:text-slate-400">
            Convert text to natural sounding audio
          </p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button
          pButton
          label="View History"
          icon="pi pi-history"
          outlined
          class=" p-button-secondary rounded-xl bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 text-slate-700 dark:text-slate-300 hover:border-indigo-500 hover:text-indigo-500 transition-all shadow-sm"
          (click)="showHistoryDrawer.set(true)"
        ></button>
      </div>
    </div>

    <!-- Active Session Banner -->
    @if (selectedChatId()) {
    <div
      class="mb-8 p-4 bg-indigo-50/50 dark:bg-indigo-900/10 border border-indigo-100 dark:border-indigo-900/30 rounded-2xl flex items-center justify-between animate-fade-in"
    >
      <div class="flex items-center gap-3">
        <div
          class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse shadow-[0_0_8px_rgba(79,70,229,0.5)]"
        ></div>
        <span class="text-sm font-medium text-indigo-900 dark:text-indigo-300">
          Active Session:
          <span class="font-bold ml-1">{{ activeChat()?.name }}</span>
        </span>
      </div>
      <button
        pButton
        icon="pi pi-plus"
        label="New Session"
        size="small"
        class="p-button-text  text-indigo-600 dark:text-indigo-400 font-bold hover:bg-indigo-100 dark:hover:bg-indigo-900/30"
        (click)="createNewSession()"
      ></button>
    </div>
    }

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Input Section -->
      <div class="space-y-6">
        <p-card
          styleClass="shadow-lg h-full border border-slate-100 dark:border-slate-800"
        >
          <ng-template pTemplate="title">
            <span class="text-xl font-bold text-slate-800 dark:text-white"
              >Conversion Input</span
            >
          </ng-template>

          <div class="flex flex-col h-full gap-6">
            <div class="space-y-3">
              <label
                class="block text-sm font-semibold text-slate-700 dark:text-slate-300"
              >
                Text to Synthesize
              </label>
              <textarea
                [ngModel]="textToConvert()"
                (ngModelChange)="textToConvert.set($event)"
                rows="6"
                class="w-full p-4 border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all outline-none resize-none placeholder-slate-400"
                placeholder="Enter the text you want to convert into speech..."
              ></textarea>
            </div>

            <button
              pButton
              label="Synthesize Speech"
              icon="pi pi-bolt"
              size="large"
              class="w-full bg-indigo-600 border-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-lg shadow-indigo-200 dark:shadow-none transition-all hover:-translate-y-0.5"
              [loading]="isLoading()"
              (click)="synthesize()"
            ></button>
          </div>
        </p-card>
      </div>

      <!-- Settings & Output -->
      <div class="space-y-6">
        <p-card
          styleClass="shadow-lg border border-slate-100 dark:border-slate-800"
        >
          <ng-template pTemplate="title">
            <span class="text-xl font-bold text-slate-800 dark:text-white"
              >Voice Settings</span
            >
          </ng-template>

          <div class="space-y-6">
            <!-- Voice Selection Grid -->
            <div class="grid grid-cols-2 gap-3 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar shadow-lg">
              @for (voice of voices(); track voice.name) {
              <div
                class="group p-4 rounded-xl border-2 transition-all cursor-pointer relative"
                [class.border-indigo-500]="selectedVoice() === voice.name"
                [class.bg-indigo-50]="selectedVoice() === voice.name"
                [class.dark:bg-indigo-900]="selectedVoice() === voice.name"
                [class.border-slate-100]="selectedVoice() !== voice.name"
                [class.dark:border-slate-800]="selectedVoice() !== voice.name"
                [class.hover:border-indigo-200]="selectedVoice() !== voice.name"
                (click)="selectedVoice.set(voice.name)"
              >
                <div class="flex items-center justify-between mb-1">
                  <span class="text-sm font-bold truncate pr-6">{{ voice.name }}</span>
                  <button
                    pButton
                    size="small"
                    [icon]="playingDemo() === voice.name ? 'pi pi-stop' : 'pi pi-play'"
                    class="p-button-text  p-0 text-indigo-600 absolute right-3 top-3"
                    (click)="playVoiceDemo($event, voice)"
                  ></button>
                </div>
                <div class="flex items-center justify-between text-[10px] text-slate-400">
                  <span>{{ voice.gender }}</span>
                </div>
              </div>
              }
            </div>

            @if (audioUrl()) {
            <div
              class="p-6 bg-indigo-50/50 dark:bg-indigo-900/10 border border-indigo-100 dark:border-indigo-900/30 rounded-2xl space-y-4 animate-fade-in"
            >
              <div class="flex items-center justify-between">
                <span class="text-sm font-bold text-indigo-900 dark:text-indigo-300">Generated Voice</span>
                <button
                    pButton
                    icon="pi pi-download"
                    size="small"
                    class="p-button-text text-indigo-600"
                    pTooltip="Download Audio"
                    (click)="playAudio()"
                ></button>
              </div>
              <audio [src]="audioUrl()" controls class="w-full h-10"></audio>
            </div>
            } @else if (isLoading()) {
              <div class="py-12 flex flex-col items-center gap-4 text-slate-400">
                <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                <p class="text-sm font-medium animate-pulse">Synthesizing audio...</p>
              </div>
            } @else {
              <div class="py-12 text-center text-slate-400 border-2 border-dashed border-slate-100 dark:border-slate-800 rounded-2xl">
                <i class="pi pi-volume-off text-4xl mb-3 opacity-20"></i>
                <p class="text-sm">Synthesize text to generate audio</p>
              </div>
            }
          </div>
        </p-card>
      </div>
    </div>

    <!-- History Feed -->
    <div class="mt-16 space-y-8">
      <div class="flex items-center gap-3">
        <div class="h-px flex-1 bg-slate-200 dark:bg-slate-800"></div>
        <h2 class="text-xl font-bold text-slate-400 dark:text-slate-600">
          History Feed
        </h2>
        <div class="h-px flex-1 bg-slate-200 dark:bg-slate-800"></div>
      </div>

      <div class="grid grid-cols-1 gap-6">
        @for (record of history(); track record.inputId) {
        <div
          class="group bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 p-6 rounded-2xl shadow-sm hover:shadow-md hover:border-indigo-200 dark:hover:border-indigo-900/50 transition-all duration-300 cursor-pointer animate-fade-in"
          (click)="viewHistoryRecord(record)"
        >
          <div class="flex flex-col md:flex-row gap-6">
            <div
              class="w-full md:w-32 h-24 bg-slate-50 dark:bg-slate-950 rounded-xl flex items-center justify-center border border-slate-100 dark:border-slate-800 group-hover:bg-indigo-50 dark:group-hover:bg-indigo-950/30 transition-colors"
            >
              <i
                class="pi pi-volume-up text-3xl text-slate-200 group-hover:text-indigo-400"
              ></i>
            </div>
            <div class="flex-1 space-y-3">
              <div class="flex items-center justify-between">
                <span
                  class="text-[10px] font-mono tracking-wider text-slate-400 uppercase"
                >
                  Voice: {{ record.voiceName }}
                </span>
                <span class="text-xs text-slate-500">
                  {{ record.createdAt | date : "medium" }}
                </span>
              </div>
              <p
                class="text-slate-600 dark:text-slate-300 line-clamp-2 italic"
              >
                "{{ record.inputText }}"
              </p>
              <div class="flex items-center gap-4 pt-1">
                <button
                  pButton
                  label="Play Again"
                  icon="pi pi-play"
                  size="small"
                  class="p-button-text text-indigo-600 dark:text-indigo-400 p-0"
                ></button>
              </div>
            </div>
          </div>
        </div>
        } @empty {
        <div
          class="text-center py-20 bg-slate-50/50 dark:bg-slate-900/20 rounded-3xl border-2 border-dashed border-slate-200 dark:border-slate-800"
        >
          <i
            class="pi pi-info-circle text-5xl text-slate-200 dark:text-slate-800 mb-4"
          ></i>
          <p class="text-slate-400 dark:text-slate-500">
            No history yet for this session.
          </p>
        </div>
        }
      </div>
    </div>
  </div>
</div>

<!-- History Drawer -->
<p-drawer
  [(visible)]="showHistoryDrawer"
  position="right"
  styleClass="w-full md:w-[450px] border-l border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950"
>
  <ng-template pTemplate="header">
    <div class="flex items-center justify-between w-full pr-4">
      <div class="flex items-center gap-3">
        <div
          class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900/30 rounded-xl flex items-center justify-center"
        >
          <i class="pi pi-history text-indigo-600 dark:text-indigo-400"></i>
        </div>
        <h2 class="text-2xl font-bold text-slate-900 dark:text-white">
          History
        </h2>
      </div>
    </div>
  </ng-template>

  <div class="flex flex-col h-full">
    <div class="p-6">
      <button
        pButton
        label="Start New Session"
        icon="pi pi-plus"
        size="large"  
        class="w-full bg-indigo-600 border-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-lg shadow-indigo-200 dark:shadow-none transition-all hover:-translate-y-0.5"
        (click)="createNewSession()"
      ></button>
    </div>

    <p-divider styleClass="m-0"></p-divider>

    <div class="flex-1 overflow-auto p-4 space-y-3">
      @if (chats().length > 0) { @for (chat of chats(); track chat.id) {
      <div
        class="p-4 rounded-xl border transition-all cursor-pointer group relative"
        [class.bg-indigo-50]="selectedChatId() === chat.id"
        [class.border-indigo-200]="selectedChatId() === chat.id"
        [class.dark:bg-indigo-900/20]="selectedChatId() === chat.id"
        [class.dark:border-indigo-800]="selectedChatId() === chat.id"
        [class.bg-white]="selectedChatId() !== chat.id"
        [class.dark:bg-slate-900]="selectedChatId() !== chat.id"
        [class.border-slate-100]="selectedChatId() !== chat.id"
        [class.dark:border-slate-800]="selectedChatId() !== chat.id"
        [class.hover:border-indigo-300]="selectedChatId() !== chat.id"
        (click)="selectChat(chat.id)"
      >
        <div class="flex items-center justify-between mb-2">
          <span
            class="text-sm font-bold truncate pr-8"
            [class.text-indigo-900]="selectedChatId() === chat.id"
            [class.dark:text-indigo-100]="selectedChatId() === chat.id"
            [class.text-slate-700]="selectedChatId() !== chat.id"
            [class.dark:text-slate-300]="selectedChatId() !== chat.id"
          >
            {{ chat.name }}
          </span>
          @if (selectedChatId() === chat.id) {
          <p-badge severity="info" value="Active"></p-badge>
          }
        </div>
        <div class="flex items-center text-[10px] text-slate-400 gap-2">
          <i class="pi pi-calendar"></i>
          {{ chat.createdAt | date : "medium" }}
        </div>
      </div>
      } } @else {
      <div class="text-center py-20 opacity-40">
        <i class="pi pi-folder-open text-5xl mb-4"></i>
        <p>No recent sessions</p>
      </div>
      }
    </div>
  </div>
</p-drawer>
